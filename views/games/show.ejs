<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/stylesheet/style.css">
    <link rel="stylesheet" href="/stylesheet/showGame.css">
    <script defer src="/js/messagehide.js"></script>
    <title>Document</title>
</head>
<body>
    
    <div id="design"> 
        <% if(game.backgroundImage){ %>
        <img src="<%= game.backgroundImage %>" class="gameBackground">
        <% } %>
        <%- include("../../partials/_navbar.ejs") %>
        <h1><%=game.name%></h1>
        <h3><%= !isNaN(averageScore)? averageScore:0 %>/5 <i class="fa fa-star starSelector"></i></h3>
        <p><%= reviewCount ? `From ${reviewCount} reviews` : "Be the first to leave a review" %> </p>
        <% if(user && user.isAdmin){ %>
            <a href="/games/<%= game._id%>/Edit">Edit game</a>
            <button type="button" id="delete">Delete game</button>  
        <% } %>
    </div>
    <% if(game.gallery && game.gallery.length>0){ %>
        <section id="gallery">
            <img src="" alt="" class ="galleryBackground">
            <h2>Gallery</h2>
            <div class="imageButtons">
                <i class="fa fa-arrow-circle-left previousImage"></i>
                <i class="fa fa-arrow-circle-right nextImage"></i> 
            </div>
                
        </section>
    <% } %>
    <section id="reviews">
        <h2>Reviews</h2>
        <button type="button" id="addReview">Leave Review</button>
        <form action="/games/<%=game._id%>/review/create" method="POST" id="reviewForm">
            <label for="description">Please enter your thoughts on the game</label>
            <textarea name="description" id="reviewInput">

            </textarea>
            <input type="number" id="ratingInput" name="rating"  max="5" min="1" value="1" required>
            <div>
                <p>How much would you rate this game</p>
                <i class="fa fa-star starSelector"></i>
                <i class="fa fa-star-o starSelector"></i>
                <i class="fa fa-star-o starSelector"></i>
                <i class="fa fa-star-o starSelector"></i>
                <i class="fa fa-star-o starSelector"></i>
            </div>
            <div>
                <button type="button" id="hideForm"> Cancel</button>
                <button type="submit">Submit</button>
            </div>
            
        </form>
      
        <div class="reviews">
            <% game.reviews.forEach((review)=>{%>
                <div class="review">
                    <div class="reviewHead">
                        <p><%=reviewNames[review.userId]%></p>
                        <% if(user){%>
                            <%console.log("review user:", review.userId, "session User", user._id, "equals", review.userId == user._id)  %>
                            <% if(review.userId.equals(user._id)) {%>
                                <i class="fa fa-ellipsis-v reviewSettings"></i>
                            <% } %>
                        <%} %>
                    </div>
                    <div class="reviewOptions">
                        <div id="showReviewDelForm">Delete</div>
                    </div>
                    <div class="reviewRating">
                        <% for(let i=0; i<5; i++){ %>
                            <%if(i<review.rating ){%>
                                <i class="fa fa-star"></i>
                            <%}else{ %>
                                <i class="fa fa-star-o"></i><% 
                            } %>
                        <%}%>
                    </div>
                    <div class="reviewBody">
                        <p><%=review.description%></p>
                    </div>
                </div>
            <%}) %>
        </div>

    </section>
    <%- include("../../partials/_deletePopup.ejs")  %>
</body>
<%if(user){%>
    <script>
    const deleteElem = document.querySelector("#delete");
    const popupElem = document.querySelector("#popup");
    const hideElem = document.querySelector("#hide");
    deleteElem.addEventListener("click", ()=>{
        const formElem = popupElem.children[0].children[0];
        formElem.action = "/games/<%=game._id%>?_method=Delete";
        const formText =  formElem.children[0];
        formText.textContent = "Are you sure you want to delete this game?";
        popupElem.style.display = "flex";
    });  
    hideElem.addEventListener("click", ()=>{
        popupElem.style.display = "none";
    });
    popupElem.addEventListener("click", (event)=>{
        if(event.target.id == "popup"){
            popupElem.style.display = "none";
        }        
    })

    const reviewButton = document.querySelector("#addReview");
    const reviewForm = document.querySelector("#reviewForm");
    const hideForm =  document.querySelector("#hideForm")
    reviewButton.addEventListener("click", ()=>{
        reviewForm.style.display=  "flex";
        reviewButton.style.display = "none";
    });
    hideForm.addEventListener("click", ()=>{
        reviewForm.style.display = "none";
        reviewButton.style.display = "block";
    })
    //gallery
    

    //rating
    const ratingInput = document.querySelector("#ratingInput");
    const starElems =  document.querySelectorAll(".starSelector");
    starElems.forEach((star, index)=>{
        star.addEventListener("click",()=>{

            const target =  index+1;
            let ctr =  0;
            
            starElems.forEach((star)=>{
                if(ctr< target){
                    star.classList.replace("fa-star-o", "fa-star");
                    ctr++
                }else{
                    star.classList.replace("fa-star", "fa-star-o");
                }
                
            })
            ratingInput.value =  target;
            console.log(ratingInput.value);
        })

    })
    
    //delete rating
   
    const reviews =  document.querySelectorAll(".review");
    const reviewObject = <%-JSON.stringify(game.reviews)%>;
    console.log(typeof reviewObject, reviewObject)
    // console.log(typeof reviewText)
    // const reviewObject = JSON.parse(reviewText);
    // console.log(typeof reviewObject)
    // console.log(JSON.parse(reviewObject))
    reviews.forEach((review, index)=>{
        const revHeadChildren= review.children[0].children;
        const reviewOptions = review.children[1];
        console.log(revHeadChildren)
        if(revHeadChildren.length >1){
            const reviewSettings =  revHeadChildren[1];
            console.log(reviewSettings.style)
            reviewSettings.addEventListener("click", (event)=>{
                reviewOptions.style.visibility="visible";
                
            })
        }
        const deleteRevOpt = reviewOptions.children[0];
        deleteRevOpt.addEventListener("click", (event)=>{
            console.log("click")
            const formElem = popupElem.children[0].children[0];
            const reviewId = reviewObject[index]._id;
            // console.log(`/games/<%=game._id%>/review/${reviewId}?_method=DELETE`)
            formElem.action = `/games/<%=game._id%>/review/${reviewId}?_method=DELETE`;
            const formText =formElem.children[0];
            formText.textContent  = "Are you sure you want to delete this review";
            popupElem.style.display = "flex";
        })
    })
    const backgroundImage = "<%=game.backgroundImage%>";
    console.log(backgroundImage)
    if(!backgroundImage || backgroundImage == ""){
        
        const designSection  = document.querySelector("#design");
        const a_elements = document.querySelectorAll("a");
        designSection.style.color = "black"; 
        a_elements.forEach(a=>a.style.color = "black");
        
    }
    if(gallery[0]==""){
        const gallerySection  = document.querySelector("#gallery");
        gallerySection.style.color =  "black";
    }

</script>    
<%}%>
<script>
    const gallerySec =  document.querySelector("#gallery");
    const gallery =  <%-JSON.stringify(game.gallery)%>;
    if(gallery.length>0){
        console.log(gallery);
        const nextImage =  document.querySelector(".nextImage");
        const previousImage = document.querySelector(".previousImage");
        let currentImage= Math.floor(Math.random()*gallery.length);
        const imgElem  =gallerySec.children[0];
        imgElem.src  =  gallery[currentImage];
        nextImage.addEventListener("click", ()=>{
            console.log((currentImage+1)%gallery.length)
            currentImage = (currentImage+1)%gallery.length;
            imgElem.src  =  gallery[currentImage];
        }); 
        previousImage.addEventListener("click", ()=>{
            currentImage = (currentImage-1)%gallery.length;
            imgElem.src  =  gallery[currentImage];
        }); 
    }
</script>
</html>