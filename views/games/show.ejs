<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/stylesheet/style.css">
    <link rel="stylesheet" href="/stylesheet/showGame.css">
    <script defer src="/js/messagehide.js"></script>
    <title>Document</title>
</head>
<body>
    <%- include("../../partials/_navbar.ejs") %>
    <div id="page-content">
        <img src="<%= game. %>" alt="">
    <% if(user.isAdmin){ %>
        <a href="/games/<%= game._id%>/Edit">Edit game</a>
        <button type="button" id="delete">Delete game</button>  
    <% } %>
        <h2>Reviews</h2>
        <button type="button" id="addReview">Leave Review</button>
        <form action="/games/<%=game._id%>/review/create" method="POST" id="reviewForm">
            <textarea name="description" id="">

            </textarea>
            <input type="number" id="ratingInput" name="rating"  max="5" min="1" value="1" required>
            <div>
                <p>How much would you recommend</p>
                <i class="fa fa-star-o starSelector"></i>
                <i class="fa fa-star-o starSelector"></i>
                <i class="fa fa-star-o starSelector"></i>
                <i class="fa fa-star-o starSelector"></i>
                <i class="fa fa-star-o starSelector"></i>
            </div>
            <button type="button" id="hideForm"> Cancel</button>
            <button type="submit">Submit</button>
        </form>
        
        <div>
            <% game.reviews.forEach((review)=>{%>
                <div class="review">
                    <div class="reviewHead">
                        <p><%=reviewNames[review.userId]%></p>
                        <%console.log("review user:", review.userId, "session User", user._id, "equals", review.userId == user._id)  %>
                        <% if(review.userId.equals(user._id)) {%>
                            <i class="fa fa-ellipsis-v reviewSettings"></i>

                        <% } %>
                    </div>
                    <div class="reviewOptions">
                        <div id="showReviewDelForm">Delete</div>
                    </div>
                    <div class="reviewRating">
                        <% for(let i=0; i<5; i++){ %>
                            <%if(i<review.rating ){%>
                                <i class="fa fa-star"></i>
                            <%}else{ %>
                                <i class="fa fa-star-o"></i><% 
                            } %>
                        <%}%>
                    </div>
                    <div class="reviewBody">
                        <p><%=review.description%></p>
                    </div>
                </div>
            <%}) %>
        </div>
    </div>
    <div id="popup">
        <div class="alert-box">
            <form action="" method="post" id>
                <p></p>
                <div class="buttons">
                    <button type="button" id="hide">Cancel</button>
                    <button type="submit">Delete</button>  
                </div>
            
            </form>
        </div>
        
    </div>
      <%- include("../../partials/_message.ejs") %>
</body>
<script>
    const deleteElem = document.querySelector("#delete");
    const popupElem = document.querySelector("#popup");
    const hideElem = document.querySelector("#hide");
    deleteElem.addEventListener("click", ()=>{
        const formElem = popupElem.children[0].children[0];
        
        formElem.action = "/games/<%=game._id%>?_method=Delete";
        const formText =  formElem.children[0];
        formText.textContent = "Are you sure you want to delete this game?";
        popupElem.style.visibility = "visible";
    });  
    hideElem.addEventListener("click", ()=>{
        popupElem.style.visibility = "hidden";
    });
    popupElem.addEventListener("click", (event)=>{
        console.log()
        if(event.target.id == "popup"){
            popupElem.style.visibility = "hidden";
        }        
    })

    const reviewButton = document.querySelector("#addReview");
    const reviewForm = document.querySelector("#reviewForm");
    const hideForm =  document.querySelector("#hideForm")
    reviewButton.addEventListener("click", ()=>{
        reviewForm.style.display=  "block";
        reviewButton.style.display = "none";
    });
    hideForm.addEventListener("click", ()=>{
        reviewForm.style.display = "none";
        reviewButton.style.display = "block";
    })


    //rating
    const ratingInput = document.querySelector("#ratingInput");
    const starElems =  document.querySelectorAll(".starSelector");
    starElems.forEach((star, index)=>{
        star.addEventListener("click",()=>{

            const target =  index+1;
            let ctr =  0;
            
            starElems.forEach((star)=>{
                if(ctr< target){
                    star.classList.replace("fa-star-o", "fa-star");
                    ctr++
                }else{
                    star.classList.replace("fa-star", "fa-star-o");
                }
                
            })
            ratingInput.value =  target;
            console.log(ratingInput.value);
        })

    })
    
    //delete rating
    const reviews =  document.querySelectorAll(".review");
    const reviewObject = <%-JSON.stringify(game.reviews)%>;
    console.log(typeof reviewObject, reviewObject)
    // console.log(typeof reviewText)
    // const reviewObject = JSON.parse(reviewText);
    // console.log(typeof reviewObject)
    // console.log(JSON.parse(reviewObject))
    reviews.forEach((review, index)=>{
        const revHeadChildren= review.children[0].children;
        const reviewOptions = review.children[1];
        console.log(revHeadChildren)
        if(revHeadChildren.length >1){
            const reviewSettings =  revHeadChildren[1];
            console.log(reviewSettings.style)
            reviewSettings.addEventListener("click", (event)=>{
                reviewOptions.style.visibility="visible";
            })
        }
        const deleteRevOpt = reviewOptions.children[0];
        deleteRevOpt.addEventListener("click", ()=>{
            const formElem = popupElem.children[0].children[0];
            const reviewId = reviewObject[index]._id;
            // console.log(`/games/<%=game._id%>/review/${reviewId}?_method=DELETE`)
            formElem.action = `/games/<%=game._id%>/review/${reviewId}?_method=DELETE`;
            const formText =formElem.children[0];
            formText.textContent  = "Are you sure you want to delete this review";
            popupElem.style.visibility = "visible";
        })
    });
    // // const reviewSettings = document.querySelectorAll("#reviewSettings");
    // const showDelForm = document.querySelectorAll("#showReviewDelForm");


    // reviewSettings.addEventListener("click", (event)=>{
    //     if(event.target == reviewSettings){

    //     }
    // })




</script>
</html>